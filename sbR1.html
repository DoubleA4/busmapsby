<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Suroboyo Bus R1</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='tracker.css'>
    <!-- <script src='main.js'></script> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script src="https://raw.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
</head>
<body>
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([-7.3026644, 112.7243344], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        async function getRoute() {
            var datenow = new Date;
            var dd = String(datenow.getDate()).padStart(2, '0');
            var mm = String(datenow.getMonth() + 1).padStart(2, '0');
            var yyyy = datenow.getFullYear();
            var datenows = yyyy +"-"+mm+"-"+dd;
            const response = await fetch(`http://36.66.208.109/gbapi/gobis/init/us/1/1/1/${datenows} 00:00:01/${datenows} 00:00:01/${datenows} 00:00:01`);
            const data = await response.json();

            var routePoly = L.polyline(data.datarute, {color: 'red', opacity: 0.5}).addTo(map);
			map.fitBounds(routePoly.getBounds());

            const datahalte = data.datahalte;

            datahalte.forEach(halte => {
                if(!halte.timetable) {
                    const halteIcon = L.icon({
						iconUrl: 'images/halte1.png',
						iconSize: [15, 18]
					});
                    L.marker([halte.lat, halte.lon], {icon: halteIcon}).bindPopup(`<b>${halte.nama}</b><br><a href="https://maps.google.com?saddr=Current+Location&daddr=${halte.lat},${halte.lon}"> >> Arah ke Tempat Ini << </a>`).addTo(map);
                } else {
                    const halteIcon = L.icon({
                        iconUrl: 'images/halte2.png',
                        iconSize: [15, 18]
                    });
                    L.marker([halte.lat, halte.lon], {icon: halteIcon}).bindPopup(`<b>${halte.nama}</b><br><a href="https://maps.google.com?saddr=Current+Location&daddr=${halte.lat},${halte.lon}"> >> Arah ke Tempat Ini << </a><br>Timetable<br><small>*) dapat berubah sewaktu waktu tergantung keadaan lalu lintas</small>${halte.timetable}`).addTo(map);
                }
            });
        }
        getRoute();

        var markers = [];
        async function getData() {
            const response = await fetch('https://suroboyobus.surabaya.go.id/gbapi/gobisbaru/sbybus/detailsbybus/1');
            const data = await response.json();

            const busIcon = L.icon({
                iconUrl: 'images/buskuning.png',
                iconSize: [15, 31],
                iconAnchor: [7.5, 15],
                labelAnchor: [5, 10]
            });

            var counter = 0;
            if (markers.length < 1) {
                data.forEach(vehicle => {
                    markers[counter] = L.marker([vehicle.lat, vehicle.lng], {icon: busIcon, rotationAngle: vehicle.direction}).addTo(map).bindPopup(`${vehicle.keterangan}<br><b>Kecepatan :</b> ${vehicle.speed}`).bindTooltip(vehicle.info, {direction: 'auto', permanent: 'false', opacity: 0.9});
                    counter++;
                });
            } else {
                data.forEach(vehicle => {
                    markers[counter].setRotationAngle(vehicle.direction);
                    markers[counter].setLatLng([vehicle.lat, vehicle.lng]);
                    counter++;
                })
            }
            counter = 0;
        }

        getData();

        setInterval(getData, 5000);
    </script>
</body>
</html>